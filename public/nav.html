<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Opening…</title>
    <meta name="robots" content="noindex" />
    <link rel="canonical" href="/nav.html" />
    <style>
      :root { color-scheme: light dark; }
      body { margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji; }
      .wrap { min-height: 100vh; display: grid; place-items: center; padding: 24px; }
      .card { max-width: 520px; width: 100%; border: 1px solid hsl(0 0% 80% / .3); border-radius: 12px; padding: 20px; background: hsl(0 0% 100% / .8); backdrop-filter: blur(8px); box-shadow: 0 10px 30px rgba(0,0,0,.08); }
      @media (prefers-color-scheme: dark) { .card { background: hsl(0 0% 10% / .5); border-color: hsl(0 0% 30% / .4); } body { background:#0b0b0c; color:#fafafa;} }
      h1 { font-size: 18px; margin: 0 0 8px; }
      p { margin: 0 0 16px; opacity: .8; }
      button { appearance: none; border: 0; padding: 10px 14px; border-radius: 10px; background: #111827; color: #fff; font-weight: 600; cursor: pointer; }
      @media (prefers-color-scheme: dark) { button { background:#2563eb; } }
    </style>
  </head>
  <body>
    <main class="wrap">
      <section class="card">
        <h1>Opening your notification…</h1>
        <p>If it doesn’t open automatically, tap Continue.</p>
        <button id="continue">Continue</button>
      </section>
    </main>
    <script>
      (function(){
        const params = new URLSearchParams(location.search);
        const target = params.get('to') || '/';
        const token = params.get('ntk');
        const mode = params.get('mode'); // 'new' means this is from a fresh notification click

        // Best-effort telemetry (non-blocking)
        try {
          fetch('/functions/v1/track-notification-event', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'nav_bounce_loaded', url: target, token: token || undefined })
          }).catch(()=>{});
        } catch(_){}

        // Stash intent for the app to consume if needed
        try { sessionStorage.setItem('pwa.nav-intent', target); } catch(_){}
        if ('BroadcastChannel' in window) {
          try { new BroadcastChannel('nav-handoff-v1').postMessage({ type: 'SW_NAVIGATE', url: target }); } catch(_){}
        }

        // Check if we're in a new tab/window context vs embedded in PWA
        const isNewContext = mode === 'new' || window === window.top;

        // Try immediate redirect (should work under notification click gesture)
        const go = () => {
          try { location.replace(new URL(target, location.origin).toString()); }
          catch { location.replace(target); }
        };

        // Only auto-redirect if we're in a new context (not embedded in PWA)
        if (isNewContext) {
          setTimeout(go, 10);
        }

        document.getElementById('continue').addEventListener('click', function(){
          try {
            fetch('/functions/v1/track-notification-event', {
              method: 'POST', headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ type: 'nav_bounce_click', url: target, token: token || undefined })
            }).catch(()=>{});
          } catch(_){}
          go();
        });
      })();
    </script>
  </body>
</html>
