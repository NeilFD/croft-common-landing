<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Croft Common</title>
    <meta name="description" content="Hospitality For Good - Croft Common Bristol">
    <meta name="author" content="Croft Common" />
    <link rel="canonical" href="https://www.croftcommontest.com/" />
    
    <!-- Favicon and App Icons -->
    <link rel="icon" href="/brand/logo.png" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="/brand/logo.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/brand/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/brand/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/brand/logo.png">
    <meta name="msapplication-TileImage" content="/brand/logo.png">
    
    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Croft Common">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- Preload critical images for instant load -->
    <link rel="preload" as="image" href="/brand/logo.png" fetchpriority="high">
    <link rel="preload" as="image" href="/lovable-uploads/d1fb9178-8f7e-47fb-a8ac-71350264d76f.png" fetchpriority="high">
    <link rel="preload" as="image" href="/lovable-uploads/d5beaa31-a043-41ea-a2a6-5bc0e4d46d03.png" fetchpriority="high">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Work+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">

    <meta property="og:title" content="Croft Common - Pure Hospitality" />
    <meta property="og:description" content="Pure Hospitality - Croft Common Bristol" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="/brand/logo.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Croft Common - Pure Hospitality" />
    <meta name="twitter:description" content="Pure Hospitality - Croft Common Bristol" />
    <meta name="twitter:image" content="/brand/logo.png" />
    
    <!-- Temporary window.open debugging shim -->
    <script>
      (function() {
        if (window.location.hostname === 'localhost' || window.location.hostname.includes('capacitor')) {
          const originalOpen = window.open;
          window.open = function(...args) {
            console.log('üîç [TEMP SHIM] window.open called with:', args);
            console.trace('üîç [TEMP SHIM] Call stack:');
            return originalOpen.apply(this, args);
          };
          setTimeout(() => {
            console.log('üîç [TEMP SHIM] Disabled after 10 seconds');
            window.open = originalOpen;
          }, 10000);
        }
      })();
    </script>
    
    <!-- Bootstrap canonicalisation and token routing BEFORE React loads -->
    <script>
      (function () {
        try {
          var w = window;
          var loc = w.location;
          var hasCap = !!w.Capacitor;
          var isNative = false;
          try { isNative = hasCap && typeof w.Capacitor.isNativePlatform === 'function' && w.Capacitor.isNativePlatform(); } catch (e) { isNative = false; }
          // Fallback detection for WKWebView before Capacitor bridge is ready
          if (!isNative) {
            try { if (w.webkit && w.webkit.messageHandlers) { isNative = true; } } catch (e) {}
          }
          var host = loc.hostname;
          var search = loc.search || '';
          var hash = loc.hash || '';
           var hasRecoveryTokens = /access_token=|refresh_token=|code=|type=recovery|token_hash=/.test(search + hash);
 
           if (!isNative) {
             var onApex = host === 'croftcommontest.com';
             var onWww = host === 'www.croftcommontest.com';
             var onLogin = /^\/management\/login\/?$/.test(loc.pathname);
 
             if (hasRecoveryTokens) {
              // Single-hop: always send tokens directly to /management/login on www
              if (onApex || (onWww && !onLogin)) {
                var target = 'https://www.croftcommontest.com/management/login' + search + hash;
                console.info('[bootstrap] Directing tokens to /management/login on www');
                w.location.replace(target);
                return;
              }
            } else {
              // No tokens: canonicalise apex -> www preserving path
              if (onApex) {
                var newUrl = 'https://www.croftcommontest.com' + loc.pathname + search + hash;
                console.info('[bootstrap] Canonicalising to www');
                w.location.replace(newUrl);
                return;
              }
            }
          }
          
          // ===== ULTRA-EARLY NATIVE BOOT BEACON =====
          // Fire immediately if native, before React loads
          if (isNative) {
            var sessionId = 'mobile-debug-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
            var platform = 'unknown';
            try {
              platform = w.Capacitor.getPlatform ? w.Capacitor.getPlatform() : 'unknown';
            } catch (e) {}
            
            var bootPayload = JSON.stringify({
              session_id: sessionId,
              step: 'native_boot',
              platform: platform,
              user_agent: navigator.userAgent.substring(0, 500),
              ts: new Date().toISOString()
            });
            
            // Try sendBeacon first (most reliable)
            if (navigator.sendBeacon) {
              var beaconUrl = 'https://xccidvoxhpgcnwinnyin.supabase.co/functions/v1/mobile-debug-log';
              var blob = new Blob([bootPayload], { type: 'application/json' });
              navigator.sendBeacon(beaconUrl, blob);
              console.log('üì± [native_boot] Beacon sent');
            } else {
              // Fallback to fetch
              fetch('https://xccidvoxhpgcnwinnyin.supabase.co/functions/v1/mobile-debug-log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: bootPayload,
                keepalive: true
              }).catch(function(e) {
                console.warn('üì± [native_boot] Failed:', e);
              });
            }
            
            // Store session ID for later use
            try {
              localStorage.setItem('cc_boot_session_id', sessionId);
            } catch (e) {}
          }
        } catch (e) { /* swallow to avoid blocking app */ }
      })();
    </script>
    <script id="early-error-catcher">
      (function(){
        try{
          var isNative = !!(window.Capacitor && typeof window.Capacitor.isNativePlatform==='function' && window.Capacitor.isNativePlatform());
          function showOverlay(text){
            try{
              var el=document.getElementById('early-error-overlay');
              if(!el){
                el=document.createElement('div');
                el.id='early-error-overlay';
                el.setAttribute('role','alert');
                el.style.position='fixed';
                el.style.inset='0';
                el.style.background='#0b0b0b';
                el.style.color='#ffffff';
                el.style.fontFamily='ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, sans-serif';
                el.style.fontSize='14px';
                el.style.lineHeight='1.4';
                el.style.padding='16px';
                el.style.zIndex='2147483647';
                el.style.overflow='auto';
                el.innerHTML='<h1 style="margin:0 0 8px 0;font-size:16px;">Start-up error</h1><pre id="early-error-pre" style="white-space:pre-wrap;word-break:break-word;margin:0;background:#111;padding:12px;border-radius:8px;border:1px solid #333;"></pre>';
                document.documentElement.appendChild(el);
              }
              var pre = document.getElementById('early-error-pre');
              if(pre){ pre.textContent = text; }
            }catch(e){}
          }
          function record(err){
            var sess = null;
            try { sess = localStorage.getItem('cc_boot_session_id'); } catch(e){}
            var payload = {
              session_id: sess || ('mobile-debug-' + Date.now()),
              step: 'early_eval_error',
              time: new Date().toISOString(),
              user_agent: navigator.userAgent.substring(0, 500),
              url: location.href,
              message: String(err && err.message || err),
              stack: err && err.stack || null
            };
            try{ localStorage.setItem('cc_last_error', JSON.stringify(payload)); }catch(e){}
            try{
              var body = JSON.stringify(payload);
              if (navigator.sendBeacon) {
                var blob = new Blob([body], { type: 'application/json' });
                navigator.sendBeacon('https://xccidvoxhpgcnwinnyin.supabase.co/functions/v1/mobile-debug-log', blob);
              } else {
                fetch('https://xccidvoxhpgcnwinnyin.supabase.co/functions/v1/mobile-debug-log', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body,
                  keepalive: true
                }).catch(function(){});
              }
            } catch(e){}
            if(isNative){ showOverlay('[native] ' + payload.message + (payload.stack? '\n' + payload.stack : '')); }
          }
          window.addEventListener('error', function(e){ if(e && e.error){ record(e.error); } else { record(e.message); } }, {once:false});
          window.addEventListener('unhandledrejection', function(e){ record(e && e.reason || 'unhandledrejection'); }, {once:false});
        }catch(e){}
      })();
    </script>
    <script id="native-link-guard-early">
      (function(){
        try{
          var w = window;
          var cap = w.Capacitor;
          var isNative = false;
          try {
            isNative = !!(cap && typeof cap.isNativePlatform==='function' && cap.isNativePlatform());
            if(!isNative && w.webkit && w.webkit.messageHandlers){ isNative = true; }
          } catch(e){}
          if(!isNative) return;

          var end = Date.now() + 5000;
          var origOpen = w.open;

          function resolveUrl(u){ try { return new URL(u, w.location.href); } catch(e){ return null; } }
          function isSameOrigin(u){
            var url = resolveUrl(u);
            return !!(url && url.origin === w.location.origin);
          }

          function deferExternal(u, features){
            var delay = Math.max(0, end - Date.now());
            console.log('[native_link_guard:early] external blocked during boot, deferring', u);
            setTimeout(function(){
              try{
                var r = resolveUrl(u);
                var href = r ? r.href : u;
                var browser = cap && (cap.Plugins && cap.Plugins.Browser) || w.Browser;
                if(browser && typeof browser.open === 'function'){
                  browser.open({ url: href });
                } else {
                  origOpen ? origOpen.call(w, href, '_self', features) : (w.location.href = href);
                }
              }catch(e){}
            }, delay);
          }

          // Intercept window.open during boot
          w.open = function(u, target, features){
            var t = target || '_blank';
            if(Date.now() < end && (t === '_blank' || !target)){
              var r = resolveUrl(u);
              if(r && isSameOrigin(r.href)){
                console.log('[native_link_guard:early] same-origin ‚Üí in-webview', r.href);
                w.location.assign(r.href);
              } else {
                deferExternal(u, features);
              }
              return null;
            }
            return origOpen ? origOpen.apply(w, arguments) : null;
          };

          // Capture _blank clicks during boot
          function onGlobalClick(e){
            try{
              var el = e.target && (e.target.closest ? e.target.closest('a[target="_blank"]') : null);
              if(!el) return;
              var href = el.getAttribute('href');
              if(!href) return;
              if(Date.now() >= end) return; // let the standard guard take over
              e.preventDefault();
              if(isSameOrigin(href)){
                var r = resolveUrl(href); if(r){ console.log('[native_link_guard:early] click same-origin ‚Üí in-webview', r.href); w.location.assign(r.href); }
              } else {
                deferExternal(href);
              }
            } catch(err){}
          }
          w.addEventListener('click', onGlobalClick, true);

          console.log('[native_link_guard:early] enabled for 5000ms');
          setTimeout(function(){
            try{
              w.removeEventListener('click', onGlobalClick, true);
              w.open = origOpen;
              console.log('[native_link_guard:early] relaxed ‚Üí standard guard');
            }catch(e){}
          }, Math.max(0, end - Date.now()));
        }catch(e){}
      })();
    </script>
    <script>
      (function(){
        try{
          var w = window;
          var cap = w.Capacitor;
          var isNative = false;
          try {
            isNative = !!(cap && typeof cap.isNativePlatform==='function' && cap.isNativePlatform());
            if(!isNative && w.webkit && w.webkit.messageHandlers){ isNative = true; }
          } catch(e){}
          if(!isNative) return;

          console.log('[native_link_guard] enabled');

          function resolveUrl(u){
            try { return new URL(u, w.location.href); } catch(e){ return null; }
          }
          function isSameOrigin(u){
            var url = resolveUrl(u);
            if(!url) return false;
            return url.origin === w.location.origin;
          }

          var origOpen = w.open;
          w.open = function(u, target, features){
            try{
              var url = resolveUrl(u);
              var t = target || '_blank';
              if(t === '_blank' || !target){
                if(url && isSameOrigin(url.href)){
                  console.log('[native_link_guard] _blank same-origin ‚Üí in-webview', url.href);
                  w.location.assign(url.href);
                  return null;
                } else {
                  var browser = cap && (cap.Plugins && cap.Plugins.Browser) || w.Browser;
                  if(browser && typeof browser.open === 'function'){
                    console.log('[native_link_guard] _blank external ‚Üí Capacitor Browser', u);
                    browser.open({ url: (url? url.href : u) });
                    return null;
                  } else {
                    console.log('[native_link_guard] _blank external ‚Üí fallback _self', u);
                    return origOpen ? origOpen.call(w, u, '_self', features) : (w.location.href = u);
                  }
                }
              }
              return origOpen ? origOpen.apply(w, arguments) : null;
            }catch(err){
              try{ return origOpen ? origOpen.apply(w, arguments) : null; }catch(e){}
            }
          };

          function onGlobalClick(e){
            try{
              var el = e.target && (e.target.closest ? e.target.closest('a[target="_blank"]') : null);
              if(!el) return;
              var href = el.getAttribute('href');
              if(!href) return;
              e.preventDefault();
              if(isSameOrigin(href)){
                console.log('[native_link_guard] click _blank same-origin ‚Üí in-webview', href);
                var r = resolveUrl(href); if(r) { w.location.assign(r.href); }
              } else {
                var browser = cap && (cap.Plugins && cap.Plugins.Browser) || w.Browser;
                var r2 = resolveUrl(href);
                if(browser && typeof browser.open === 'function' && r2){
                  console.log('[native_link_guard] click _blank external ‚Üí Capacitor Browser', href);
                  browser.open({ url: r2.href });
                } else {
                  console.log('[native_link_guard] click _blank external ‚Üí fallback _self', href);
                  w.open(href, '_self');
                }
              }
            } catch(err){}
          }

          w.addEventListener('click', onGlobalClick, true);
        }catch(e){}
      })();
    </script>
  </head>

  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
